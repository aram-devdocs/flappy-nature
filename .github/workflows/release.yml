name: Release & Publish

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to publish (e.g., flappy-nature-game-v0.2.1)"
        required: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs['flappy-nature-game--release_created'] || steps.check-release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs['flappy-nature-game--tag_name'] || steps.check-release.outputs.tag_name }}
      version: ${{ steps.release.outputs['flappy-nature-game--version'] || steps.check-release.outputs.version }}
      prs_created: ${{ steps.release.outputs.prs_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.RELEASE_PAT }}
      - name: Check if release was created
        id: check-release
        if: steps.release.outputs['flappy-nature-game--release_created'] != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # release-please sometimes creates a release without setting outputs.
          # Check the PR it just processed for the autorelease:tagged label.
          PR_NUMBER=$(gh pr list --state merged --label "autorelease: tagged" \
            --json number,mergedAt --jq 'sort_by(.mergedAt) | last | .number' \
            --repo "${{ github.repository }}" 2>/dev/null || echo "")
          if [ -z "$PR_NUMBER" ]; then
            echo "No recently tagged release PR found"
            exit 0
          fi
          # Find the release that was just created
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' \
            --repo "${{ github.repository }}" 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            echo "No releases found"
            exit 0
          fi
          # Extract version from tag (flappy-nature-game-v0.2.1 -> 0.2.1)
          VERSION=$(echo "$LATEST_TAG" | sed 's/flappy-nature-game-v//')
          echo "Found release: $LATEST_TAG (v$VERSION)"
          echo "release_created=true" >> "$GITHUB_OUTPUT"
          echo "tag_name=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  format-release-pr:
    needs: release-please
    if: needs.release-please.outputs.prs_created == 'true'
    runs-on: ubuntu-latest
    env:
      HUSKY: "0"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: release-please--branches--main--components--flappy-nature-game
      - uses: pnpm/action-setup@v4
        with:
          standalone: true
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
      - run: pnpm install --frozen-lockfile
      - run: pnpm format
      - name: Push formatting fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore: auto-format release PR with biome"
            git push
          else
            echo "No formatting changes needed"
          fi

  auto-merge-release-pr:
    needs: [release-please, format-release-pr]
    if: needs.release-please.outputs.prs_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_BRANCH="release-please--branches--main--components--flappy-nature-game"
          PR_NUMBER=$(gh pr list --head "$PR_BRANCH" --json number --jq '.[0].number' --repo "${{ github.repository }}")
          if [ -n "$PR_NUMBER" ]; then
            gh pr merge "$PR_NUMBER" --auto --squash --repo "${{ github.repository }}"
          fi

  publish:
    needs: release-please
    if: >-
      !cancelled() &&
      (needs.release-please.outputs.release_created == 'true' ||
       github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    environment: npm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name || github.event.inputs.tag_name }}
      - uses: pnpm/action-setup@v4
        with:
          standalone: true
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Verify bundle integrity
        run: |
          for f in packages/flappy-nature-game/dist/index.js packages/flappy-nature-game/dist/index.cjs; do
            if grep -q '@repo/' "$f"; then
              echo "ERROR: Found @repo/ references in $f"
              grep '@repo/' "$f"
              exit 1
            fi
          done
          echo "Bundle integrity check passed"
      - name: Prepare package for publishing
        working-directory: packages/flappy-nature-game
        run: |
          cp ../../LICENSE ./LICENSE

          node -e "
            const pkg = require('./package.json');
            pkg.name = 'flappy-nature-game';
            delete pkg.devDependencies;
            if (pkg.dependencies) {
              for (const [k, v] of Object.entries(pkg.dependencies)) {
                if (String(v).includes('workspace:')) delete pkg.dependencies[k];
              }
              if (Object.keys(pkg.dependencies).length === 0) delete pkg.dependencies;
            }
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          node -e "
            const fs = require('fs');
            const path = require('path');
            const typesDir = path.resolve('../../packages/types/dist');
            const uiDir = path.resolve('../../packages/ui/dist');
            const hooksDir = path.resolve('../../packages/hooks/dist');
            const typesDts = fs.readFileSync(path.join(typesDir, 'index.d.ts'), 'utf8');
            const uiDts = fs.readFileSync(path.join(uiDir, 'index.d.ts'), 'utf8');
            const hooksDts = fs.readFileSync(path.join(hooksDir, 'index.d.ts'), 'utf8');
            for (const ext of ['d.ts', 'd.cts']) {
              const dtsPath = path.join('dist', 'index.' + ext);
              let dts = fs.readFileSync(dtsPath, 'utf8');
              dts = dts.replace(/^import .* from '@repo\/.*';?\n?/gm, '');
              dts = dts.replace(/^export \{[^}]*\} from '@repo\/.*';?\n?/gm, '');
              const header = [
                '// Inlined from @repo/types', typesDts.replace(/^export /gm, 'export '), '',
                '// Inlined from @repo/ui', uiDts, '',
                '// Inlined from @repo/hooks', hooksDts, '',
              ].join('\n');
              dts = header + '\n' + dts;
              fs.writeFileSync(dtsPath, dts);
            }
            console.log('Type declarations bundled successfully');
          "
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          registry-url: https://registry.npmjs.org
      - name: Publish to npm
        working-directory: packages/flappy-nature-game
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
