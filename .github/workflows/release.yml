name: Release & Publish

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to publish (e.g., flappy-nature-game-v0.2.0)"
        required: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release-please:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs['flappy-nature-game--release_created'] }}
      tag_name: ${{ steps.release.outputs['flappy-nature-game--tag_name'] }}
      version: ${{ steps.release.outputs['flappy-nature-game--version'] }}
      prs_created: ${{ steps.release.outputs.prs_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  format-release-pr:
    needs: release-please
    if: ${{ needs.release-please.outputs.prs_created == 'true' }}
    runs-on: ubuntu-latest
    env:
      HUSKY: "0"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: release-please--branches--main--components--flappy-nature-game

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - run: pnpm install --frozen-lockfile

      - run: pnpm format

      - name: Push formatting fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore: auto-format release PR with biome"
            git push
          else
            echo "No formatting changes needed"
          fi

  publish:
    needs: release-please
    if: >-
      needs.release-please.outputs.release_created == 'true' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: npm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name || github.event.inputs.tag_name }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          registry-url: https://registry.npmjs.org

      - run: pnpm install --frozen-lockfile

      - run: pnpm build

      - name: Verify bundle integrity
        run: |
          echo "Checking dist/index.js for @repo/ references..."
          if grep -q '@repo/' packages/flappy-nature-game/dist/index.js; then
            echo "ERROR: Found @repo/ references in index.js"
            grep '@repo/' packages/flappy-nature-game/dist/index.js
            exit 1
          fi
          if grep -q '@repo/' packages/flappy-nature-game/dist/index.cjs; then
            echo "ERROR: Found @repo/ references in index.cjs"
            grep '@repo/' packages/flappy-nature-game/dist/index.cjs
            exit 1
          fi
          echo "Bundle integrity check passed"

      - name: Prepare package for publishing
        working-directory: packages/flappy-nature-game
        run: |
          # Copy LICENSE from repo root
          cp ../../LICENSE ./LICENSE

          # Rewrite package name for npm
          node -e "
            const pkg = require('./package.json');
            pkg.name = 'flappy-nature-game';
            delete pkg.devDependencies;
            // Remove workspace:* dependencies (they're bundled by tsup)
            if (pkg.dependencies) {
              for (const [k, v] of Object.entries(pkg.dependencies)) {
                if (String(v).includes('workspace:')) delete pkg.dependencies[k];
              }
              if (Object.keys(pkg.dependencies).length === 0) delete pkg.dependencies;
            }
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Bundle type declarations to remove @repo/ references
          node -e "
            const fs = require('fs');
            const path = require('path');

            // Read all workspace package d.ts files
            const typesDir = path.resolve('../../packages/types/dist');
            const uiDir = path.resolve('../../packages/ui/dist');
            const hooksDir = path.resolve('../../packages/hooks/dist');

            const typesDts = fs.readFileSync(path.join(typesDir, 'index.d.ts'), 'utf8');
            const uiDts = fs.readFileSync(path.join(uiDir, 'index.d.ts'), 'utf8');
            const hooksDts = fs.readFileSync(path.join(hooksDir, 'index.d.ts'), 'utf8');

            // Read our d.ts
            for (const ext of ['d.ts', 'd.cts']) {
              const dtsPath = path.join('dist', 'index.' + ext);
              let dts = fs.readFileSync(dtsPath, 'utf8');

              // Replace @repo/* barrel re-exports with inlined declarations
              // Remove import lines referencing @repo/*
              dts = dts.replace(/^import .* from '@repo\/.*';?\n?/gm, '');
              // Remove export lines referencing @repo/*
              dts = dts.replace(/^export \{[^}]*\} from '@repo\/.*';?\n?/gm, '');

              // Prepend the needed type declarations
              const header = [
                '// Inlined from @repo/types',
                typesDts.replace(/^export /gm, 'export '),
                '',
                '// Inlined from @repo/ui',
                uiDts,
                '',
                '// Inlined from @repo/hooks',
                hooksDts,
                '',
              ].join('\n');

              dts = header + '\n' + dts;
              fs.writeFileSync(dtsPath, dts);
            }
            console.log('Type declarations bundled successfully');
          "

          echo "Package prepared for publishing:"
          cat package.json
          echo ""
          echo "Files to publish:"
          ls -la dist/

      - name: Publish to npm
        working-directory: packages/flappy-nature-game
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
